---
title: "Postgresql学习笔记0: 源码安装与gdb调试"
date: 2024-02-12 09:55:30
category: 
- '数据库'
- 'Postgresql学习'
tags:
- '数据库'
- 'Postgresql'
---

本文介绍如何从源码安装`postgresql-14`, 更多信息请参考官方文档: https://www.postgresql.org/docs/current/

# 1 编译源码
## 1.1 安装依赖
```bash
sudo apt-get install libreadline-dev
```

## 1.2 克隆仓库并编译
```bash
git clone https://git.postgresql.org/git/postgresql.git # 克隆完整仓库
git checkout REL_14_STABLE # 切换到14分支
```

由于我们源码安装的目的是为了查看源码调试, 所以我们不需要安装到默认的`/usr/local/`路径, 需要在`configure`中指定编译安装目录, 同时需要开启`--enable-debug`允许后续的`gdb`调试:
```bash
mkdir /home/toni/pgBuild
./configure --prefix=/home/toni/pgBuild/ --enable-debug
```
然后正常编译即可
```bash
make
make install
```

## 1.3 额外编译选项
1. 编译后测试
```bash
make check
```
2. 安装额外模块
```bash
make world
```

# 2 基本配置
## 2.1 配置环境变量
将安装目录的四个文件夹添加到环境变量:
```bash
# ~/.bashrc
PATH=$PATH:/home/toni/pgBuild/bin
PATH=$PATH:/home/toni/pgBuild/include
PATH=$PATH:/home/toni/pgBuild/lib
PATH=$PATH:/home/toni/pgBuild/share
```

## 2.2 初始化数据库
新建一个数据库目录并初始化
```bash
mkdir -p pgData
initdb -D pgData
```

## 2.3 启动数据库并登录
```bash
pg_ctl -D pgData/ start
```
从`psql`连接数据库
```bash
psql postgres
```
查看当前登录信息
```sql
postgres=# \c
You are now connected to database "postgres" as user "toni".
```
可以看到, 初始化数据库目录后, 自动创建了名为`postgres`的数据库和安装时的用户`toni`


# 3 启用gdb调试
进入`pg_ctl`所在的目录, 执行如下命令:
```gdb
(gdb) layout src
(gdb) set args -D /home/toni/pgData/ start
(gdb) b main
(gdb) run
```
如果成功, 则会看到下图的内容:

![gdb-postgres](../../../../images/DB/postgresql/gdb-postgres.png)


